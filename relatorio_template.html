import streamlit as st import pandas as pd import tempfile from io import BytesIO from xhtml2pdf import pisa from PIL import Image import base64

st.set_page_config(page_title="Relat√≥rio Diagn√≥stico", layout="centered") st.title("üìà Relat√≥rio Diagn√≥stico Personalizado") st.markdown("Preencha os dados abaixo e envie os arquivos para gerar o relat√≥rio individual com base na r√©gua de an√°lise diagn√≥stica.")

nome_aluno = st.text_input("Nome do aluno") turma = st.text_input("Turma") respostas = st.text_input("Respostas do aluno (ex: A,B,C,D,A...)") arquivo_regua = st.file_uploader("Envie o arquivo .CSV com a r√©gua diagn√≥stica", type=["csv"]) arquivo_logo = st.file_uploader("Deseja adicionar o logotipo da escola? (PNG/JPG)", type=["png", "jpg", "jpeg"])

def calcular_nivel_conhecimento(porcentagem): if porcentagem >= 80: return "Avan√ßado" elif porcentagem >= 60: return "Intermedi√°rio" elif porcentagem >= 40: return "B√°sico" else: return "Muito b√°sico / Requer apoio"
st.set_page_config(page_title="Relat√≥rio Diagn√≥stico", layout="centered")
st.title("üìà Relat√≥rio Diagn√≥stico Personalizado")
st.markdown("Preencha os dados abaixo e envie os arquivos para gerar o relat√≥rio individual com base na r√©gua de an√°lise diagn√≥stica.")
def gerar_html(relatorio, logo_b64): html = f""" <html> <head><meta charset='utf-8'></head> <body style='font-family: Arial;'> <div style='display: flex; justify-content: space-between; align-items: center;'> <h2>Relat√≥rio Diagn√≥stico Individual</h2> {'<img src="data:image/png;base64,' + logo_b64 + '" style="height: 60px;">' if logo_b64 else ''} </div> <p><strong>Nome do aluno:</strong> {relatorio['nome']}</p> <p><strong>Turma:</strong> {relatorio['turma']}</p> <p><strong>Total de acertos:</strong> {relatorio['acertos']}</p> <p><strong>Desempenho:</strong> {relatorio['desempenho']}%</p> <p><strong>N√≠vel de conhecimento:</strong> {relatorio['nivel']}</p>

<p><strong>‚ñ† Habilidades que o aluno j√° domina:</strong></p>
<ul>
    {''.join(f'<li>{hab}</li>' for hab in relatorio['habilidades_domina']) if relatorio['habilidades_domina'] else '<li>Nenhuma habilidade evidenciada</li>'}
</ul>

<p><strong>‚ñ†‚ñ† Habilidades que precisam de aten√ß√£o:</strong></p>
<ul>
    {''.join(f'<li>{hab}</li>' for hab in relatorio['habilidades_erro']) if relatorio['habilidades_erro'] else '<li>Nenhuma habilidade cr√≠tica identificada</li>'}
</ul>

<p style='font-size: small; color: gray;'>Relat√≥rio gerado automaticamente com base na an√°lise das respostas e habilidades da BNCC.</p>
</body>
</html>
"""
return html

def converter_pdf(html): pdf_file = BytesIO() pisa.CreatePDF(BytesIO(html.encode("utf-8")), dest=pdf_file) return pdf_file

def tratar_logo(upload): if upload: imagem = Image.open(upload) imagem.thumbnail((150, 150)) buffer = BytesIO() imagem.save(buffer, format="PNG") return base64.b64encode(buffer.getvalue()).decode("utf-8") return None

if st.button("Gerar Relat√≥rio"): if not nome_aluno or not turma or not respostas or not arquivo_regua: st.error("Por favor, preencha todos os campos obrigat√≥rios.") else: df = pd.read_csv(arquivo_regua, encoding="utf-8-sig") respostas_lista = [r.strip().upper() for r in respostas.split(",") if r.strip()] acertos = 0 habilidades_domina = [] habilidades_erro = []

for i, resposta in enumerate(respostas_lista):
        questao = f"Q{i+1}"
        colunas_q = df[df["Questao"].str.upper().str.strip() == questao.upper()]

        if colunas_q.empty:
            habilidades_erro.append("Quest√£o n√£o encontrada na r√©gua")
            continue

        linha_correta = colunas_q[colunas_q["Alternativa"].str.upper().str.strip() == resposta]
        if not linha_correta.empty:
            nivel_resp = linha_correta.iloc[0]["N√≠vel de conhecimento do estudante"].strip().lower()
            habilidade = str(linha_correta.iloc[0]["BNCC relacionada"])

            if nivel_resp == "correta" or "avan√ßado" in nivel_resp:
                acertos += 1
                habilidades_domina.append(habilidade)
            else:
                habilidades_erro.append(habilidade)
        else:
            habilidades_erro.append("Resposta n√£o encontrada na r√©gua")

    desempenho = round((acertos / len(respostas_lista)) * 100, 1) if respostas_lista else 0
    nivel = calcular_nivel_conhecimento(desempenho)

    relatorio = {
        "nome": nome_aluno,
        "turma": turma,
        "acertos": acertos,
        "desempenho": desempenho,
        "nivel": nivel,
        "habilidades_domina": list(set(habilidades_domina)),
        "habilidades_erro": list(set(habilidades_erro)),
    }

    logo_b64 = tratar_logo(arquivo_logo)
    html = gerar_html(relatorio, logo_b64)
    pdf = converter_pdf(html)

    st.success("Relat√≥rio gerado com sucesso!")
    st.download_button(
        label="üíæ Baixar PDF do relat√≥rio",
        data=pdf,
        file_name=f"relatorio_{nome_aluno.replace(' ', '_')}.pdf",
        mime="application/pdf",
    )
